---
title: "Additive Gaussian Process"
author: "Qingyuan Yang"
date: "2024-08-16"
output: html_document
---

## Additive Gaussian Process-based emulator for climate model Perturbed Parameter Ensembles (PPEs)

This document presents an example to work with this method, which is a additive Gaussian Process-based method. It is specifically designed for climate model PPE datasets, which are characterized by very limited samples (ensemble members) compared to the dimensions of the parameter space.

```{r}
rm(list = ls())
```

## Specify the parameters

1.  Set up the working directory.

2.  Create a case.

3.  Select the index of the variable to emulate.\
    Note: each case corresponds to a directory. Within each directory, a new directory with the name of the target variable will be created. All results (trained emulator, figures and tables indicating the performance of the method) will be saved there.

    With this design, a case could comprise of results for several target variables.

```{r}
# Specify and set the working directory
wd = "~/Documents/code_proj/simp_add_gp/" 
setwd(wd)

# Specify a case name. Each case could have many target variabels
case_name = "cam6_global"                  
# Specify the index of the variable of interest to be emulated.
# In this case, the 6th variable will be emulated
y_ind = 6

```

## Specify the parameters required to run the method

```{r}
# Whether parameter group of three is considered here.
# It is set as a flag because selecting the parameter groups of three is time-consuming.
# groupthree_flag = 0 -> not consider parameter groups of three
# groupthree_flag = 1 -> consider parameter groups of three

groupthree_flag = 0 

# Number of 
#   single parameters
#   parameter pairs
#   parameter groups of three that will be selected
no_single = 20
no_pairs = 15
no_groups = 10

# Specify parameters for the Gaussian Process adopted in this method
range_pre = c(0.6, 0.5, 0.4)
# In this specification, the range (lengh scale) for one-, two-, and three-parameter GPs
# will be 0.6, 0.5, 0.4, respectively.
# This is appropriate for parameters that are normalized to the range of zero to one
# Specify the variance-to-noise ratio 
nugget_pre = 4

```

## Notes on parameter and parameter groups selection
This method split the training data into the "trn" (normally 80% of the training data) and "val". The number of parameters are determined by training the method based on "trn", applying it to "val", and then determine whether the selected parameters could help improve the emulator performance when applied to "val". 

threshold1_pre and threshold2_pre are the thresholds for individual parameters and parameter groups (including two and three parameters). 

If they are zero, then we only allow parameters and parameter groups that improve the fitting (reduce the error) to be included. 

If they are 0.01, then parameters that (1) do not help with the emulation and (2) contribute to less than 0.01 of the variability will not be considered.

They can be negative values, too. In such case, if they don't contribute enough, they will not be sidered
```{r}
threshold1_pre = 0.00
threshold2_pre = 0.000

trn_ratio = 0.8 * 0.8
val_ratio = 0.8 * 0.2
```